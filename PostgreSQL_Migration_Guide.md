# MySQL到PostgreSQL迁移指南

本指南详细说明了如何将Survey Product项目从MySQL数据库迁移到PostgreSQL数据库，以便在Render.com上部署。

## 迁移概述

### 完成的工作

1. **依赖项更新**
   - 更新了 `requirements.txt`，将 `PyMySQL` 替换为 `psycopg2-binary`
   - 保留了 `PyMySQL` 作为迁移脚本的依赖

2. **配置文件更新**
   - 更新了 `config.py` 中的默认数据库URL格式
   - 更新了 `.env.example` 中的示例连接字符串
   - 更新了 `alembic.ini` 中的数据库URL
   - 更新了 `render.yaml` 中的生产环境数据库配置

3. **数据库模式迁移**
   - 创建了 `SurveyPostgreSQL_schema.sql` 包含PostgreSQL兼容的表结构
   - 创建了 `migrate_data.py` 数据迁移脚本
   - 创建了新的Alembic迁移文件 `1a2b3c4d5e6f_postgresql_initial_migration.py`

## 迁移步骤

### 步骤1: 准备PostgreSQL数据库

1. 在Render.com上创建PostgreSQL数据库实例
2. 获取连接信息：主机、端口、用户名、密码、数据库名

### 步骤2: 更新环境变量

创建或更新 `.env` 文件：

```env
DATABASE_URL="postgresql://username:password@host:5432/database_name"
SECRET_KEY="your-secret-key-here"
OPENROUTER_API_KEY=your-openrouter-api-key
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

### 步骤3: 执行数据迁移

#### 方法1: 使用迁移脚本（推荐）

1. 确保已安装所有依赖：
   ```bash
   pip install -r requirements.txt
   ```

2. 修改 `migrate_data.py` 中的数据库连接配置：
   ```python
   MYSQL_CONFIG = {
       'host': 'localhost',
       'port': 3306,
       'user': 'root',
       'password': 'your_mysql_password',  # 填入MySQL密码
       'database': 'survey_db',
       'charset': 'utf8mb4'
   }

   POSTGRES_CONFIG = {
       'host': 'your_postgres_host',
       'port': 5432,
       'user': 'your_postgres_user',
       'password': 'your_postgres_password',  # 填入PostgreSQL密码
       'database': 'survey_db'
   }
   ```

3. 运行迁移脚本：
   ```bash
   python migrate_data.py
   ```

#### 方法2: 使用pgloader工具（可选）

如果您更熟悉pgloader工具，可以使用以下命令：

```bash
pgloader mysql://user:password@host:3306/survey_db postgresql://user:password@host:5432/survey_db
```

### 步骤4: 运行Alembic迁移

```bash
# 设置数据库URL环境变量
export DATABASE_URL="postgresql://username:password@host:5432/database_name"

# 运行Alembic迁移
python -m alembic upgrade head
```

### 步骤5: 验证迁移

1. 检查数据完整性：
   ```bash
   python -c "
   from backend.app.database import engine
   from backend.app.models import User, Organization, Survey, Question
   from sqlalchemy.orm import sessionmaker
   
   Session = sessionmaker(bind=engine)
   session = Session()
   
   print(f'用户数量: {session.query(User).count()}')
   print(f'组织数量: {session.query(Organization).count()}')
   print(f'问卷数量: {session.query(Survey).count()}')
   print(f'问题数量: {session.query(Question).count()}')
   
   session.close()
   "
   ```

2. 运行应用程序测试：
   ```bash
   # 启动应用
   python -m uvicorn backend.app.main:app --host 0.0.0.0 --port 8000
   
   # 在另一个终端运行测试
   python test_question_creation.py
   ```

## 数据类型转换说明

### 主要差异

1. **自增主键**
   - MySQL: `AUTO_INCREMENT`
   - PostgreSQL: `SERIAL` 或 `GENERATED BY DEFAULT AS IDENTITY`

2. **布尔类型**
   - MySQL: `TINYINT(1)`
   - PostgreSQL: `BOOLEAN`

3. **枚举类型**
   - MySQL: `ENUM('value1', 'value2')`
   - PostgreSQL: `VARCHAR` 或自定义ENUM类型

4. **时间戳**
   - MySQL: `DATETIME` 或 `TIMESTAMP`
   - PostgreSQL: `TIMESTAMP`

5. **JSON字段**
   - MySQL: `JSON`
   - PostgreSQL: `JSONB` (推荐) 或 `JSON`

### 已处理的数据转换

迁移脚本自动处理以下转换：

1. **布尔值转换**: MySQL的TINYINT(1)转换为PostgreSQL的BOOLEAN
2. **JSON数据**: 确保JSON字符串格式正确
3. **时间戳**: 处理MySQL和PostgreSQL之间的时间戳格式差异
4. **自增ID**: 正确设置PostgreSQL的SERIAL类型

## 部署到Render.com

### 更新render.yaml

确保 `render.yaml` 中的数据库配置正确：

```yaml
services:
  - type: web
    name: survey-product-backend
    env: python
    plan: free
    buildCommand: |
      npm install --prefix frontend &&
      npm run build --prefix frontend &&
      pip install -r requirements.txt
    startCommand: cd survey_product_doc && python -m alembic upgrade head && python -m uvicorn backend.app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATABASE_URL
        value: "postgresql://survey_user:password@your-postgres-host:5432/survey_db"
      - key: SECRET_KEY
        generateValue: true
      - key: OPENROUTER_API_KEY
        value: "your-openrouter-api-key"
      - key: ENVIRONMENT
        value: "production"
    healthCheckPath: /api/v1/health
```

### 部署步骤

1. 将代码推送到GitHub
2. 在Render.com上连接GitHub仓库
3. 创建PostgreSQL数据库服务
4. 创建Web服务，连接到数据库
5. 设置环境变量
6. 部署应用

## 故障排除

### 常见问题

1. **连接错误**
   - 检查数据库连接字符串格式
   - 确保防火墙允许连接
   - 验证用户名和密码

2. **数据类型错误**
   - 检查迁移脚本中的数据类型转换
   - 确保枚举值正确映射

3. **外键约束错误**
   - 确保表按正确顺序创建
   - 检查外键引用是否有效

4. **Alembic迁移错误**
   - 确保数据库URL正确设置
   - 检查迁移文件语法

### 调试技巧

1. **启用详细日志**:
   ```python
   import logging
   logging.basicConfig()
   logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)
   ```

2. **检查迁移状态**:
   ```bash
   python -m alembic current
   python -m alembic history
   ```

3. **回滚迁移**:
   ```bash
   python -m alembic downgrade -1
   ```

## 性能优化

### PostgreSQL优化建议

1. **索引优化**
   - 为常用查询字段创建索引
   - 使用复合索引优化多字段查询

2. **查询优化**
   - 使用EXPLAIN ANALYZE分析查询计划
   - 优化复杂的JOIN查询

3. **连接池配置**
   - 在生产环境中配置适当的连接池大小
   - 考虑使用连接池中间件

## 后续维护

1. **定期备份**
   - 设置自动备份策略
   - 测试备份恢复流程

2. **监控**
   - 监控数据库性能
   - 设置警报机制

3. **更新**
   - 定期更新PostgreSQL版本
   - 保持依赖项最新

---

## 联系支持

如果在迁移过程中遇到问题，请：

1. 检查日志文件中的错误信息
2. 参考PostgreSQL和SQLAlchemy文档
3. 搜索相关错误消息
4. 联系技术支持团队

迁移完成后，您的应用将成功运行在PostgreSQL数据库上，并准备好在Render.com上部署。